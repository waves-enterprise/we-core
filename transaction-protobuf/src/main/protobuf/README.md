# WE Protobuf

## Deserializing byte fields

All fields related to cryptography (public key, hash, signature) are represented as byte arrays.
String representation of these fields (like in REST API) can be obtained by encoding of byte arrays to Base58.

* id - hash
* sender_public_key - public key
* author_public_key - public key
* validator_public_key - public key
* miner - address
* proofs - array of signatures
* assetId - hash
* contract_id - hash
* trusted_sender - address
* recipients - array of addresses
* recipient - address
* owners - array of addresses
* lease_id - hash
* data_hash - hash
* policy_id - hash
* target - public key

### Exceptions

#### Alias
Alias byte array has the following structure:

| Byte array index |  Type  |              Description             |
|:----------------:|:------:|:------------------------------------:|
|         0        |  Byte  | Object type flag. 1=Address, 2=Alias |
|         1        |  Byte  |               Chain Id               |
|        2-3       |  Short |        Size of array with name       |
|       4-end      | String |             Name in UTF-8            |

To get a string representation (like in REST API), you need to concatenate:
1. Prefix "alias:"
2. The byte at index 1 (network byte) converted to Char
3. Separator ":"
4. Bytes from index 4 up to the end converted to UTF-8 String

#### Address
Address byte array has the following structure:

| Byte array index |    Type    |              Description             |
|:----------------:|:----------:|:------------------------------------:|
|         0        |    Byte    | Object type flag. 1=Address, 2=Alias |
|         1        |    Byte    |               Chain Id               |
|       2-21       | Byte array |                 Hash                 |
|       22-25      | Byte array |               Checksum               |

String representation (like in REST API) has the Base58 encoding.

## Source code generation

Instructions for most of the programming languages can be found here: https://grpc.io/docs/languages/

### Rust
1. Install `protoc`: `brew install protobuf` or `apt-get install protobuf-compiler`
2. Install `grpc`: `brew install grpc` 
3. Install `rustup`: https://doc.rust-lang.org/cargo/getting-started/installation.html
4. Init `rustup`: `rustup-init`
5. Install `protobuf-codegen` with `cargo`: `cargo install protobuf-codegen`
6. Add `$PATH`: `export PATH="$HOME/.cargo/bin:$PATH"`
7. Source code will be generated by the following command: `protoc --proto_path=we-transaction-protobuf --rust_out=rust we-transaction-protobuf/*.proto`

## Handling errors

Error codes and messages are returned in Response's Metadata using specific keys:
* `error-code` – contains internal error code
* `error-message` – contains details about the error

## Contract API version

Since Node version `v1.6.2` a new field `apiVersion` has been introduced along with `CreateContractTransactionV4` and `UpdateContractTransactionV4`.
It declares the Contract gRPC API version that is required to be supported by a mining node in order to run that contract.


The `managed/api_version.proto` file contains the actual version for Contract gRPC API.
Contracts whose required `apiVersion` is greater than that of the miner node will be ignored by that node during mining.

Contract API versions:
* `1.0`: default API version for nodes `v1.6.0` and older;
* `1.1`: API version for node `v1.6.2`.

To access API version field from source code please follow the instruction: https://developers.google.com/protocol-buffers/docs/proto#customoptions